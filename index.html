<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WOL Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2a2a2a;
            --text-color: #e0e0e0;
            --accent: #4CAF50;
            --error: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        }

        h1 { 
            margin-bottom: 30px; 
            font-size: 1.5rem; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            color: #888; 
        }

        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –ö–ù–û–ü–ö–ò --- */
        .btn-3d {
            font: inherit;
            background-color: #2a2a2a;
            border: 0;
            color: #e0e0e0;
            border-radius: 0.5em;
            font-size: 1.35rem;
            padding: 0.6em 1.5em; /* –û—Ç—Å—Ç—É–ø—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞ */
            font-weight: 600;
            text-shadow: 0 0.0625em 0 #000;
            
            /* –®–∏—Ä–∏–Ω–∞ —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—Å—Ç–∞ (auto), –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 140px */
            width: auto; 
            min-width: 140px; 
            display: inline-block;

            box-shadow:
                inset 0 0.0625em 0 0 #3a3a3a,
                0 0.0625em 0 0 #252525,
                0 0.125em 0 0 #202020,
                0 0.25em 0 0 #1c1c1c,
                0 0.3125em 0 0 #181818,
                0 0.375em 0 0 #141414,
                0 0.425em 0 0 #101010,
                0 0.425em 0.5em 0 #0a0a0a;
            transition: 0.15s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-3d:active:not(:disabled) {
            translate: 0 0.225em;
            box-shadow:
                inset 0 0.03em 0 0 #3a3a3a,
                0 0.03em 0 0 #252525,
                0 0.0625em 0 0 #202020,
                0 0.125em 0 0 #1c1c1c,
                0 0.125em 0 0 #181818,
                0 0.2em 0 0 #141414,
                0 0.225em 0 0 #101010,
                0 0.225em 0.375em 0 #0a0a0a;
        }

        .btn-3d:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #777;
        }

        .auth-form {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: #111;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            text-align: center;
        }

        #log { margin-top: 30px; color: #666; font-size: 0.9rem; min-height: 1.2em; }
        
        .logout-link {
            margin-top: 50px;
            color: #555;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .hidden { display: none !important; }
        .status-success { color: var(--accent) !important; font-weight: bold; }
        .status-error { color: var(--error) !important; }
        .status-wait { color: #FFA500 !important; }

    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div id="authScreen" class="container hidden">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h1>
        <div class="auth-form">
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ Supabase</p>
            
            <input type="text" id="inputUrl" placeholder="Project URL">
            <input type="password" id="inputKey" placeholder="Anon Key">
            
            <!-- –¢–µ–ø–µ—Ä—å —ç—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ç–∞–∫–∞—è –∂–µ —Å—Ç–∏–ª—å–Ω–∞—è -->
            <button class="btn-3d" onclick="saveCredentials()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ü–£–õ–¨–¢ -->
    <div id="controlScreen" class="container hidden">
        <h1>–ü–ö CONTROL</h1>
        
        <button id="mainBtn" class="btn-3d" onclick="sendWakeUp()">WAKE UP</button>
        
        <p id="log">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

        <div class="logout-link" onclick="logout()">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>

    <script>
        let sbClient = null;

        function init() {
            const savedUrl = localStorage.getItem('sb_url');
            const savedKey = localStorage.getItem('sb_key');

            if (savedUrl && savedKey) {
                try {
                    const { createClient } = supabase;
                    sbClient = createClient(savedUrl, savedKey);
                    
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('controlScreen').classList.remove('hidden');
                    resetBtnState(); // –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –°–±—Ä–æ—Å.");
                    logout();
                }
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('controlScreen').classList.add('hidden');
            }
        }

        function saveCredentials() {
            const url = document.getElementById('inputUrl').value.trim();
            const key = document.getElementById('inputKey').value.trim();

            if (!url || !key) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!");
                return;
            }
            localStorage.setItem('sb_url', url);
            localStorage.setItem('sb_key', key);
            init(); 
        }

        function logout() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?")) {
                localStorage.removeItem('sb_url');
                localStorage.removeItem('sb_key');
                location.reload();
            }
        }

        async function sendWakeUp() {
            const btn = document.getElementById('mainBtn');
            const log = document.getElementById('log');

            btn.disabled = true;
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê...";
            log.className = "status-wait";
            log.innerText = "–°–∏–≥–Ω–∞–ª —É—Ö–æ–¥–∏—Ç –≤ –æ–±–ª–∞–∫–æ...";

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç –æ—Ç ESP
            const channel = sbClient
                .channel('room_wol_check')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'devices', filter: 'id=eq.1' }, 
                    (payload) => {
                        if (payload.new.is_active === false) {
                            commandSuccess();
                            sbClient.removeChannel(channel); 
                        }
                    }
                )
                .subscribe();

            // –û—Ç–ø—Ä–∞–≤–∫–∞
            const { error } = await sbClient
                .from('devices')
                .update({ is_active: true })
                .eq('id', 1);

            if (error) {
                log.className = "status-error";
                log.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message;
                sbClient.removeChannel(channel);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ - —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ä–∞–∑—É, –Ω–æ —Å —Ç–µ–∫—Å—Ç–æ–º –æ—à–∏–±–∫–∏
                setTimeout(resetBtnState, 2000); 
            } else {
                log.innerText = "–ñ–¥—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç ESP...";
                
                // –¢–∞–π–º-–∞—É—Ç
                setTimeout(() => {
                    if (btn.disabled && btn.innerText !== "–£–°–ü–ï–•!") {
                        log.className = "status-error";
                        log.innerText = "–¢–∞–π–º-–∞—É—Ç: ESP –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞";
                        sbClient.removeChannel(channel);
                        setTimeout(resetBtnState, 2000);
                    }
                }, 10000);
            }
        }

        function commandSuccess() {
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Power Control</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üñ•Ô∏è</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --text-color: #e0e0e0;
            --accent: #4CAF50;
            --error: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { 
            margin-bottom: 30px; 
            font-size: 1.5rem; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            color: #666; 
        }

        .btn-3d {
            font: inherit;
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: #e0e0e0;
            border-radius: 0.5em;
            font-size: 1.35rem;
            padding: 0.6em 1.5em;
            font-weight: 600;
            text-shadow: 0 0.0625em 0 #000;
            width: auto; 
            min-width: 140px; 
            display: inline-block;
            box-shadow:
                inset 0 0.0625em 0 0 #3a3a3a,
                0 0.0625em 0 0 #000,
                0 0.125em 0 0 #050505,
                0 0.25em 0 0 #050505,
                0 0.3125em 0 0 #050505,
                0 0.375em 0 0 #050505,
                0 0.425em 0 0 #050505,
                0 0.425em 0.5em 0 #000;
            transition: 0.15s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-3d:active:not(:disabled) {
            translate: 0 0.225em;
            box-shadow:
                inset 0 0.03em 0 0 #3a3a3a,
                0 0.03em 0 0 #252525,
                0 0.0625em 0 0 #202020,
                0 0.125em 0 0 #1c1c1c,
                0 0.125em 0 0 #181818,
                0 0.2em 0 0 #141414,
                0 0.225em 0 0 #101010,
                0 0.225em 0.375em 0 #0a0a0a;
        }

        .btn-3d:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #555;
            box-shadow: none;
            border-color: #222;
        }

        .auth-form {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #333;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: #050505;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            text-align: center;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
        }

        #log { margin-top: 30px; color: #666; font-size: 0.9rem; min-height: 1.2em; }
        
        .logout-link {
            margin-top: 50px;
            color: #444;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .hidden { display: none !important; }
        .status-success { color: var(--accent) !important; font-weight: bold; }
        .status-error { color: var(--error) !important; }
        .status-wait { color: #FFA500 !important; }

    </style>
</head>
<body>

    <div id="authScreen" class="container hidden">
        <h1>Setup</h1>
        <div class="auth-form">
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">Enter Supabase Project Details</p>
            
            <input type="text" id="inputUrl" placeholder="Project URL">
            <input type="password" id="inputKey" placeholder="Anon Key">
            
            <button class="btn-3d" onclick="saveCredentials()">Save</button>
        </div>
    </div>

    <div id="controlScreen" class="container hidden">
        <h1>POWER CONTROL</h1>
        
        <button id="mainBtn" class="btn-3d" onclick="sendWakeUp()">WAKE UP</button>
        
        <p id="log">Loading...</p>

        <div class="logout-link" onclick="logout()">Reset settings</div>
    </div>

    <script>
        let sbClient = null;

        function init() {
            const savedUrl = localStorage.getItem('sb_url');
            const savedKey = localStorage.getItem('sb_key');

            if (savedUrl && savedKey) {
                try {
                    const { createClient } = supabase;
                    sbClient = createClient(savedUrl, savedKey);
                    
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('controlScreen').classList.remove('hidden');
                    resetBtnState();
                } catch (e) {
                    alert("Invalid data. Resetting.");
                    logout();
                }
            } else {
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('controlScreen').classList.add('hidden');
            }
        }

        function saveCredentials() {
            const url = document.getElementById('inputUrl').value.trim();
            const key = document.getElementById('inputKey').value.trim();

            if (!url || !key) {
                alert("Please fill in both fields!");
                return;
            }
            localStorage.setItem('sb_url', url);
            localStorage.setItem('sb_key', key);
            init(); 
        }

        function logout() {
            if(confirm("Remove keys from device?")) {
                localStorage.removeItem('sb_url');
                localStorage.removeItem('sb_key');
                location.reload();
            }
        }

        async function sendWakeUp() {
            const btn = document.getElementById('mainBtn');
            const log = document.getElementById('log');

            btn.disabled = true;
            btn.innerText = "SENDING...";
            log.className = "status-wait";
            log.innerText = "Signal sent to cloud...";

            const channel = sbClient
                .channel('room_wol_check')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'devices', filter: 'id=eq.1' }, 
                    (payload) => {
                        if (payload.new.is_active === false) {
                            commandSuccess();
                            sbClient.removeChannel(channel); 
                        }
                    }
                )
                .subscribe();

            const { error } = await sbClient
                .from('devices')
                .update({ is_active: true })
                .eq('id', 1);

            if (error) {
                log.className = "status-error";
                log.innerText = "Network error: " + error.message;
                sbClient.removeChannel(channel);
                setTimeout(resetBtnState, 2000); 
            } else {
                log.innerText = "Waiting for confirmation...";
                
                setTimeout(() => {
                    if (btn.disabled && btn.innerText !== "SUCCESS!") {
                        log.className = "status-error";
                        log.innerText = "Timeout: Device didn't respond";
                        sbClient.removeChannel(channel);
                        setTimeout(resetBtnState, 2000);
                    }
                }, 10000);
            }
        }

        function commandSuccess() {
            const btn = document.getElementById('mainBtn');
            const log = document.getElementById('log');
            
            btn.innerText = "SUCCESS!";
            log.className = "status-success";
            log.innerText = "PC is turning on (Confirmed)";
            
            if (navigator.vibrate) navigator.vibrate(200);

            setTimeout(resetBtnState, 4000);
        }

        function resetBtnState() {
            const btn = document.getElementById('mainBtn');
            const log = document.getElementById('log');

            btn.disabled = false;
            btn.innerText = "WAKE UP";
            log.innerText = "Ready";
            log.className = "";
        }

        init();
    </script>
</body>
</html>
